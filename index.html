<versione 35 del gioco>
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Super Tardigradin</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body { margin: 0; background: #000; }
    canvas { display: block; margin: auto; }
  </style>
</head>
<body>
<script>
class BootScene extends Phaser.Scene {
  constructor() { super('BootScene'); }

  preload() {
    this.load.audio('jump', 'boing.wav');
    this.load.audio('victory', 'victory.wav');
    this.load.audio('gameover', 'gameover.wav');
    this.load.audio('start', 'start.wav');
    this.load.audio('star', 'star.wav');
    this.load.audio('death', 'death.wav');
    this.load.audio('enemy', 'enemy.wav');
  }

  create() {
    this.cameras.main.setBackgroundColor('#001122');
    this.add.rectangle(this.scale.width / 2, this.scale.height / 2, this.scale.width, this.scale.height, 0x001122);

    this.tweens.add({
      targets: this.cameras.main,
      onUpdate: (tween) => {
        const v = Math.sin(tween.progress * Math.PI * 2) * 30 + 30;
        this.cameras.main.setBackgroundColor(Phaser.Display.Color.GetColor(0, v, v * 3));
      },
      duration: 4000,
      yoyo: true,
      repeat: -1
    });

    this.add.text(this.scale.width / 2, 180, 'ðŸ¦  SUPER TARDIGRADIN ðŸ¦ ', {
      fontSize: '48px',
      fill: '#00ffcc',
      fontFamily: 'monospace',
      stroke: '#003333',
      strokeThickness: 6
    }).setOrigin(0.5);

    this.add.text(this.scale.width / 2, 280, '\nâ­ ðŸ’§ ðŸŒ¿ ðŸŒˆ â­', {
      fontSize: '30px',
      fill: '#ffff88'
    }).setOrigin(0.5);

    const startText = this.add.text(this.scale.width / 2, 380,
		'Clicca o premi un tasto per iniziare',
		{ fontSize: '22px', fill: '#ffffff', fontFamily: 'monospace' }
		).setOrigin(0.5);

	this.tweens.add({
		targets: startText,
		alpha: { from: 1, to: 0.3 },
		duration: 1000,
		yoyo: true,
		repeat: -1
	});

	// Nuova riga istruzioni controlli
	this.add.text(this.scale.width / 2, 420,
	'Spacebar per saltare, Alt per sparare, oppure usa il gamepad',
	{ fontSize: '18px', fill: '#ffdd88', fontFamily: 'monospace' }
	).setOrigin(0.5);


    const unlockAudio = () => {
      if (this.sound.context.state === 'suspended') this.sound.context.resume();
      this.sound.play('start');
      this.scene.start('MainScene');
    };

    this.input.once('pointerdown', unlockAudio);
    this.input.keyboard.once('keydown', unlockAudio);
  }
}

class MainScene extends Phaser.Scene {
  constructor() { super('MainScene'); }

  preload() {
    this.load.image('sky', 'sky.png');
    this.load.image('ground', 'platform_v1.png');

    // Nemici
    this.load.image('enemy', 'mostro.png');
    this.load.image('enemyAlt', 'mostro_01.png');

    // Player
    this.load.image('playerR', 'tardigrado_R_00.png');
    this.load.image('playerL', 'tardigrado_L_00.png');
    this.load.image('playerR_walk1', 'tardigrado_R_01.png');
    this.load.image('playerR_walk2', 'tardigrado_R_02.png');
    this.load.image('playerL_walk1', 'tardigrado_L_01.png');
    this.load.image('playerL_walk2', 'tardigrado_L_02.png');

    this.load.image('star', 'star.png');
    this.load.image('bullet', 'bullet.png');
  }

  init(data) {
    this.lives = data.lives ?? 3;
    this.score = data.score ?? 0;
  }

  create() {
    const bg = this.add.image(0, 0, 'sky').setOrigin(0).setScrollFactor(0);
    bg.displayWidth = this.scale.width;
    bg.displayHeight = this.scale.height;
    bg.setDepth(-10);

    this.physics.world.gravity.y = 900;
    this.levelWidth = 3000;

    this.jumpSound = this.sound.add('jump');
    this.victorySound = this.sound.add('victory');
    this.starSound = this.sound.add('star');
    this.deathSound = this.sound.add('death');
    this.enemySound = this.sound.add('enemy');

    // Piattaforme
    this.platforms = this.physics.add.staticGroup();
    for (let x = 0; x < this.levelWidth; x += 400)
      this.platforms.create(x, 580, 'ground').setScale(2).refreshBody();

    this.platforms.create(600, 440, 'ground');
    this.platforms.create(900, 330, 'ground');
    this.platforms.create(1300, 222, 'ground');
    this.platforms.create(1700, 385, 'ground');
    this.platforms.create(2200, 275, 'ground');
    this.platforms.create(2600, 165, 'ground');

    // Player
    const groundPlatform = this.platforms.getChildren().find(p => p.y === 580);
    const groundTop = groundPlatform.y - groundPlatform.displayHeight / 2;

    this.player = this.physics.add.sprite(100, 0, 'playerR');
    this.player.setScale(0.6);
    this.player.setBounce(0.1);
    this.player.setCollideWorldBounds(true);
    this.player.facing = 'right';

    const bodyWidth = 60 * 0.6;
    const bodyHeight = 90 * 0.6;
    this.player.body.setSize(bodyWidth, bodyHeight);
    this.player.body.setOffset(20 * 0.6, 20 * 0.6);
    this.player.y = groundTop - bodyHeight / 2;

    this.physics.add.collider(this.player, this.platforms);

    this.anims.create({ key: 'walkR', frames: [{ key: 'playerR_walk1' }, { key: 'playerR_walk2' }], frameRate: 6, repeat: -1 });
    this.anims.create({ key: 'walkL', frames: [{ key: 'playerL_walk1' }, { key: 'playerL_walk2' }], frameRate: 6, repeat: -1 });

    // Controlli
    this.cursors = this.input.keyboard.createCursorKeys();
    this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
    this.fireKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ALT);

    // Proiettili
    this.bullets = this.physics.add.group();
    this.lastFired = 0;

    // Nemici
    this.enemies = this.physics.add.group();
    let highPlatforms = this.platforms.getChildren().filter(p => p.y < 580);

    const totalEnemies = highPlatforms.length + 2;
    const numAlt = Math.floor(totalEnemies / 2);

    const textures = [];
    for (let i = 0; i < numAlt; i++) textures.push('enemyAlt');
    for (let i = numAlt; i < totalEnemies; i++) textures.push('enemy');
    Phaser.Utils.Array.Shuffle(textures);

    // Nemici piattaforme alte
    highPlatforms.forEach((platform, i) => {
      const tex = textures.shift();
      let e = this.enemies.create(600 + i * 300, 0, tex);
      e.setScale(0.12);
      let platformTop = platform.y - platform.displayHeight / 2;
      e.y = platformTop - e.displayHeight / 2;
      e.setVelocityX(100);
      e.setCollideWorldBounds(true);

      // Pulsazione nemici
	this.tweens.add({
		targets: e,
		scaleX: 0.14,
		scaleY: 0.14,
		yoyo: true,
		repeat: -1,
		duration: 600,
		ease: 'Sine.easeInOut'
		});
    });

    const groundY = groundTop;
    this.groundEnemies = [
      this.enemies.create(2400, 0, textures.shift()),
      this.enemies.create(2800, 0, textures.shift())
    ];

    this.groundEnemies.forEach(e => {
      e.setScale(0.12);
      e.y = groundY - e.displayHeight / 2;
      e.setCollideWorldBounds(true);
      e.homeX = e.x;
      e.patrolRange = 80;
      e.setVelocityX(50);

      // Pulsazione
      this.tweens.add({
        targets: e,
        scaleX: 0.125,
        scaleY: 0.125,
        yoyo: true,
        repeat: -1,
        duration: 500,
        ease: 'Sine.easeInOut'
      });
    });

    this.physics.add.collider(this.enemies, this.platforms);
    this.physics.add.overlap(this.player, this.enemies, this.playerVsEnemy, null, this);
    this.physics.add.overlap(this.bullets, this.enemies, this.bulletHitsEnemy, null, this);

    // Stelle
    this.stars = this.physics.add.group({ key: 'star', repeat: 20, setXY: { x: 100, y: 0, stepX: 130 } });
    this.stars.children.iterate(s => s.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8)));
    this.physics.add.collider(this.stars, this.platforms);
    this.physics.add.overlap(this.player, this.stars, this.collectStar, null, this);

    // UI
    this.uiText = this.add.text(16, 16, '', { fontSize: '20px', fill: '#fff' }).setScrollFactor(0).setDepth(1000);
    this.updateUI();

    // Camera
    this.cameras.main.setBounds(0, 0, this.levelWidth, this.scale.height);
    this.physics.world.setBounds(0, 0, this.levelWidth, this.scale.height);
    this.cameras.main.startFollow(this.player, true, 0.08, 0.08);
  }

  update() {
    const p = this.player.body;

    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    let pad = null;
    for (let gp of pads) if (gp && gp.connected) pad = gp;

    let left = this.cursors.left.isDown;
    let right = this.cursors.right.isDown;
    let jump = this.spaceKey.isDown;
    let fire = this.fireKey.isDown;

    if (pad) {
      const axisX = pad.axes[0];
      if (axisX < -0.3) { left = true; right = false; }
      else if (axisX > 0.3) { right = true; left = false; }
      if (pad.buttons[2].pressed) jump = true;
      if (pad.buttons[1].pressed) fire = true;
    }

    // Movimento player
    if (left) {
      p.setVelocityX(-220);
      this.player.facing = 'left';
      if (!this.player.anims.isPlaying || this.player.anims.currentAnim.key !== 'walkL') this.player.play('walkL');
    } else if (right) {
      p.setVelocityX(220);
      this.player.facing = 'right';
      if (!this.player.anims.isPlaying || this.player.anims.currentAnim.key !== 'walkR') this.player.play('walkR');
    } else {
      p.setVelocityX(0);
      this.player.setTexture(this.player.facing === 'right' ? 'playerR' : 'playerL');
    }

    // Salto
    if (jump && p.blocked.down) {
      p.setVelocityY(-500);
      this.jumpSound.play();
    }

    // Sparo parabolico
    if (fire && this.time.now > this.lastFired + 300) {
      const dir = this.player.facing === 'right' ? 1 : -1;
      const bullet = this.bullets.create(this.player.x + dir * 40, this.player.y, 'bullet');
      bullet.setVelocityX(600 * dir);
      bullet.setVelocityY(-150);
      bullet.setScale(0.3);
      bullet.setCollideWorldBounds(false);
      bullet.body.allowGravity = true;
      bullet.body.gravity.y = 200;
      this.lastFired = this.time.now;
    }

    // Nemici piattaforme alte
    this.enemies.children.iterate(e => {
      if (!this.groundEnemies.includes(e)) {
        if (e.body.blocked.left) e.setVelocityX(100);
        else if (e.body.blocked.right) e.setVelocityX(-100);
      }
    });

    // Nemici terreno
    this.groundEnemies.forEach(e => {
      if (e.x < e.homeX - e.patrolRange) e.setVelocityX(50);
      else if (e.x > e.homeX + e.patrolRange) e.setVelocityX(-50);
    });

    // Vittoria
    if (this.player.x > this.levelWidth - 100) {
      this.victorySound.play();
      this.scene.start('WinScene', { score: this.score });
    }
  }

  collectStar(player, star) {
    star.disableBody(true, true);
    this.starSound.play();
    this.score += 10;
    this.updateUI();
  }

  updateUI() {
    this.uiText.setText('â¤ï¸ ' + this.lives + '   â­ ' + this.score);
  }

  playerVsEnemy(player, enemy) {
    if (player.invulnerable) return;
    const pb = player.body;
    const playerAbove = pb.velocity.y > 0 && pb.bottom <= enemy.body.top + 10;

    if (playerAbove) {
      this.enemySound.play();
      enemy.setTint(0xff0000);
      enemy.body.enable = false;
      this.tweens.add({ targets: enemy, alpha: 0, duration: 400, onComplete: () => enemy.destroy() });
      pb.setVelocityY(-300);
      this.score += 50;
      this.updateUI();
    } else {
      player.invulnerable = true;
      this.lives--;
      this.deathSound.play();
      this.updateUI();
      player.setTint(0xff8888);
      player.body.enable = false;
      this.cameras.main.shake(150, 0.01);
      if (this.lives > 0) {
        const rx = player.x, ry = player.y;
        this.time.delayedCall(800, () => {
          player.clearTint();
          player.body.enable = true;
          player.setPosition(rx, ry - 20);
          player.invulnerable = false;
        });
      } else {
        this.time.delayedCall(800, () => this.scene.start('GameOver', { score: this.score }));
      }
    }
  }

  bulletHitsEnemy(bullet, enemy) {
    this.enemySound.play();
    enemy.setTint(0xff0000);
    enemy.body.enable = false;
    bullet.destroy();
    this.tweens.add({ targets: enemy, alpha: 0, duration: 400, onComplete: () => enemy.destroy() });
    this.score += 50;
    this.updateUI();
  }
}

class GameOverScene extends Phaser.Scene {
  constructor() { super('GameOver'); }
  create(data) {
    this.sound.play('gameover');
    this.add.text(this.scale.width / 2, 250, 'ðŸ’€ GAME OVER ðŸ’€', { 
		fontSize: '50px', 
		fill: '#ff4444', 
		padding: { top: 20, bottom: 20 } 
	}).setOrigin(0.5, 0.5);
    this.add.text(this.scale.width / 2, 320, 'Punteggio: ' + data.score, { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
    this.add.text(this.scale.width / 2, 400, 'Premi SPAZIO per ricominciare', { fontSize: '20px', fill: '#aaa' }).setOrigin(0.5);
    this.input.keyboard.once('keydown-SPACE', () => this.scene.start('MainScene', { lives: 3, score: 0 }));
  }
}

class WinScene extends Phaser.Scene {
  constructor() { super('WinScene'); }
  create(data) {
    this.sound.play('victory');
    this.add.text(this.scale.width / 2, 250, 'ðŸŽ‰ HAI VINTO! ðŸŽ‰', { fontSize: '40px', fill: '#44ff44' }).setOrigin(0.5);
    this.add.text(this.scale.width / 2, 320, 'Punteggio: ' + data.score, { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
    this.add.text(this.scale.width / 2, 400, 'Premi SPAZIO per ricominciare', { fontSize: '20px', fill: '#aaa' }).setOrigin(0.5);
    this.input.keyboard.once('keydown-SPACE', () => this.scene.start('MainScene', { lives: 3, score: 0 }));
  }
}

const config = {
  type: Phaser.AUTO,
  width: 1600,
  height: 600,
  physics: { default: 'arcade', arcade: { debug: false } },
  scene: [BootScene, MainScene, GameOverScene, WinScene]
};

new Phaser.Game(config);
</script>
</body>
</html>
